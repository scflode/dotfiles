# prefix to Ctrl-Space
unbind C-b
set-option -g prefix C-a

# Set the correct term

# Add truecolor support
set-option -ga terminal-overrides ",xterm-256color:Tc"
# Default terminal is 256 colors
set -g default-terminal "screen-256color"

#set-option -g default-terminal "xterm-256color"
#set-option -g default-terminal "screen-256color"
#set-option -g default-terminal "tmux"
#set-option -sa terminal-overrides ',screen-256color:RGB'
#set-option -ga terminal-overrides ",screen-256color:Tc"

set-option -g focus-events on

# using C-a as the tmux prefix comes at the cost of some great features:
#   bash: move to start of line (in emacs mode, aka when i'm ssh'd somewhere)
#   vim: insert mode increment number
# this allows you to access those same features by hitting (C-a a)
bind a send-prefix

# Copy-paste integration
set-option -g default-command "reattach-to-user-namespace -l zsh"

# Buffer size
set-option -g history-limit 1000000

# Set ESC key delay
set -s escape-time 0

# Use vim keybindings in copy mode
setw -g mode-keys vi
set -g status-keys vi

# see https://github.com/tmux/tmux/issues/754#issuecomment-297452143 for latest changes in tmux
bind-key -T edit-mode-vi Up send-keys -X history-up
bind-key -T edit-mode-vi Down send-keys -X history-down

# Setup 'v' to begin selection as in Vim
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe "reattach-to-user-namespace pbcopy"

# Update default binding of `Enter` to also use copy-pipe
unbind -T copy-mode-vi Enter
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe "reattach-to-user-namespace pbcopy"

# Bind '<' to use pbpaste
bind < run "reattach-to-user-namespace pbpaste | tmux load-buffer - && tmux paste-buffer"

# Pane handling keybindings
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

unbind -T prefix Up
unbind -T prefix Down

bind-key -r -T prefix Up    resize-pane -U
bind-key -r -T prefix Down  resize-pane -D

bind-key j command-prompt -p "join pane from:"  "join-pane -s '%%'"
bind-key m command-prompt -p "move pane to:"  "join-pane -t '%%'"

# Clear screen
bind -n C-u send-keys C-l \; run-shell "sleep .3s" \; clear-history
bind-key -T prefix C-p send-keys -R \; run-shell "sleep .3s" \; clear-history

# Kill session and switch
bind-key X confirm-before -p "Kill #S (y/n)?" "run-shell 'tmux switch-client -n \\\; kill-session -t \"\$(tmux display-message -p \"#S\")\"'"

# Set window and pane index
set -g base-index 1
set -g pane-base-index 1


# Status line
set -g status on
set -g status-interval 2
set -g status-position bottom

# UI
set -g status-left-length 90
set -g status-right-length 150
set -g status-left "#(~/.tmux/themes/powerline/powerline.sh left)"
set -g status-right "#(~/.tmux/themes/powerline/powerline.sh right)"

# Color settings
set -g status-justify "centre"
set -g pane-border-style "fg=#b9b9b9"
set -g pane-active-border-style "fg=#b9b9b9"
set -g status-style "fg=#b9b9b9,bg=#1d1f22"

set -g mode-style "fg=#1d1f22,bg=#b9b9b9"

# command styles
set -g message-style "fg=#b9b9b9,bg=#1d1f22"
set -g message-command-style "fg=#b9b9b9,bg=#1d1f22"

set -g status-left-style NONE
set -g status-right-style NONE

#set -g status-left "#[fg=#15161E,bg=#7aa2f7,bold] #S #[fg=#7aa2f7,bg=#1f2335,nobold,nounderscore,noitalics]"
#set -g status-right "#[fg=#1f2335,bg=#1f2335,nobold,nounderscore,noitalics]#[fg=#7aa2f7,bg=#1f2335] #{prefix_highlight} #[fg=#3b4261,bg=#1f2335,nobold,nounderscore,noitalics]#[fg=#7aa2f7,bg=#3b4261] %Y-%m-%d  %I:%M %p #[fg=#7aa2f7,bg=#3b4261,nobold,nounderscore,noitalics]#[fg=#15161E,bg=#7aa2f7,bold] #h "

setw -g window-status-activity-style "underscore,fg=#1d1f22,bg=#b9b9b9"
setw -g window-status-separator ""
setw -g window-status-style "NONE,fg=#b9b9b9,bg=#1d1f22"
#setw -g window-status-format "#[fg=#b9b9b9,bg=#1d1f22,nobold,nounderscore,noitalics]#[default] #I  #W #F #[fg=#b9b9b9,bg=#1d1f22,nobold,nounderscore,noitalics]"
#setw -g window-status-current-format "#[fg=#b9b9b9,bg=#1d1f22,nobold,nounderscore,noitalics]#[fg=#b9b9b9,bg=#1d1f22,bold] #I  #W #F #[fg=#b9b9b9,bg=#1d1f22,nobold,nounderscore,noitalics]"
setw -g window-status-format "#[fg=#b9b9b9,bg=#1d1f22,nobold,nounderscore,noitalics]|#[default] #I #W #F "
setw -g window-status-current-format "#[fg=#b9b9b9,bg=#1d1f22,nobold,nounderscore,noitalics]|#[fg=#1d1f22,bg=#b9b9b9,bold] #I #W #F "

# tmux-vim-navigator settings
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
  | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

is_fzf="ps -o state= -o comm= -t '#{pane_tty}' \
  | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?fzf$'"

bind -n C-h run "($is_vim && tmux send-keys C-h) || \
                 tmux select-pane -L"

bind -n C-j run "($is_vim && tmux send-keys C-j)  || \
                 ($is_fzf && tmux send-keys C-j) || \
                 tmux select-pane -D"

bind -n C-k run "($is_vim && tmux send-keys C-k) || \
                 ($is_fzf && tmux send-keys C-k)  || \
                 tmux select-pane -U"

bind -n C-l run "($is_vim && tmux send-keys C-l) || \
                 tmux select-pane -R"

# continuum settings
set -g @continuum-restore 'on'
set -g @continuum-save-interval '60'
set -g @continuum-boot 'on'
set -g @continuum-boot-options 'iterm,fullscreen'

# tmux Plugins

set -g @tpm_plugins '            \
  tmux-plugins/tpm               \
  tmux-plugins/tmux-resurrect    \
  tmux-plugins/tmux-continuum    \
  tmux-plugins/tmux-yank         \
  tmux-plugins/tmux-copycat      \
  tmux-plugins/tmux-open         \
'

run-shell '~/.tmux/plugins/tpm/tpm'

